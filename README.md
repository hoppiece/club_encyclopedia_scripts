# club_encyclopedia_scripts

# 概要
Google Apps Script は, Google の諸々のサービスを Javascript 文法で操作できるようにする仕組みです. 
- Google Form から受け取った申込みフォームのメールアドレス宛に自動で登録の確認のメールを送る
- 画像をアップロードしてもらうための簡単なWebページを用意し, アップロードしたデータは Google Drive に保存して, フォームに入力された名前をつける.

方法について解説します.

# 自動返信 autoreply.gs
Google Form でメールアドレス等各種情報を登録してもらい, そこに登録完了のお知らせ等を自動で返信する. 

準備として, Goole Form を用意しておく.
## 使い方
1. フォームの解答をスプレッドシートに出力

2. スプレッドシートのツールからスクリプトエディタを開き，[autoreply.gs](https://github.com/hoppiece/club_encyclopedia_scripts/blob/master/autoreply.gs) をコピペして保存．コードの内容は送信文や質問に合わせて適宜変更．

  変更するべきなのは，
  - `title`: 送信メールのタイトルです
  - 本文
  - `name`: メール冒頭の○○様に代入される変数．今回は，解答シートの 団体名(正式名称)の列を代入する.


3. 関数のトリガーを解答を受け取ったときに設定. トリガーはApps script の編集画面の時計みたいなマークのボタンから設定できる．

## Memo
- [autoreply.gs](https://github.com/hoppiece/club_encyclopedia_scripts/blob/master/autoreply.gs) は Google Form の回答を受け取りをトリガーとして関数 autoreply() を実行する JavaScrept 風のスクリプト.
- 関数の中身では主に本文生成を行っている．具体的には  
1. 変数 `title`: メールのタイトル．
2. 変数 `body`: メールの本文．`body` にどんどん内容を足していっている．フォームの回答はGASの関数でスプレッドシートから呼び出して `body` に加えている．メール後半の内容を `footer` に書いておいて最後に `body` に足している．スプレッドシート周りの呼び出しについては [GAS のリファレンス](https://developers.google.com/apps-script/reference/spreadsheet/) を参照．

- 変数`cols`の値は，返信メールに載せたい解答要素の個数に応じて変更する．(今回は，返信メールに 1．タイムスタンプ2．メールアドレス3．電話番号4．団体名(正式名称)5．代表者氏名6．団体の分類7．活動内容8．団体についてするもの9．活動頻度10．原稿の提出形態 の項目を返信メールに盛り込むので`cols`の値は`10`にする．従来バージョンでは，回答スプレッドシートの列数を取得して`cols`に代入していたが，列に余りがあったときに空白の■が入ってしまったのでこうした．)
3. [GAS のメールまわりの関数](https://developers.google.com/apps-script/reference/gmail/)で送信．
- フォームの方で，電話番号欄を電話番号の型以外を弾くようにした．(具体的には電話番号のGoogleフォームを短答記述で `^(0[5-9]0[0-9]{8}|0[1-9][1-9][0-9]{7})$` という正規表現に一致するものだけを受け入れるようにした．  v
すると回答がスプレッドシートに流し込まれた際，電話番号が数値型だと判断されて先頭のゼロが消えてしまう．  
そこでメールを本文を作成する際，電話番号データの頭が0でないない場合は，0を追加して，スプレッドシートのデータも文字列に直すようなコードを挟んだ．
		
## 注意
- 本番環境に移行したら，データとなるシートはいじらない．要素の変更や追加や削除はコピーされたシートに対して行う．

## 参考にしたサイト
https://itwork100.com/google-form-gas/

https://dv7.jp/blog/2018/01/10/google%E3%83%95%E3%82%A9%E3%83%BC%E3%83%A0%E3%82%B9%E3%83%97%E3%83%AC%E3%83%83%E3%83%89%E3%82%B7%E3%83%BC%E3%83%88%E3%81%A8%E9%80%A3%E6%90%BA%E3%81%97%E3%81%9F%E6%99%82%E3%81%AB%E9%9B%BB%E8%A9%B1/

### コメント
本当は自分でサーバ用意していろいろ作った方が可能な実装も参考文献も充実していて作りやすそうですが生協のサーバは直接触れないので... GASならそこそこのものがタダで安全に作れて便利ですね．

# 原稿データアップロード upload.gs, index.html 使い方
アップロードフォームと，受け取った原稿データのファイル名を団体名に変更してドライブ内の指定フォルダに放り込むコードです．フォームは"手作り"なので挙動やデザインがだいぶ荒削りです．
## 使い方
1. 新規 Google Apps Script を作成．  
ドライブ内の 新規 → その他 → Google Apps Script から新規作成できる．

2. プロジェクト名を「無題のプロジェクト」から適宜変更し，コード.gs 内に
